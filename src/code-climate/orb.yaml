version: 2.1

description: |
  Commands for Code Climate.
  Originally from afrase/code-climate orb, but with the needed improvements to be usable.
  see github page for more info: https://github.com/travelaudience/orbs

commands:

  format_coverage:
    description: Locate, parse, and re-format supported coverage sources.
    parameters:
      coverage_file:
        description: The coverage file to format.
        type: string
      additional_flags:
        description: Option to set prefix (or other params) (use "--prefix=v3")
        type: string
        default: ""
      input_type:
        description: The type of input source to use.
        enum:
          - clover
          - cobertura
          - coverage.py
          - excoveralls
          - gcov
          - gocov
          - jacoco
          - lcov
          - simplecov
        type: enum
      output:
        default: coverage/codeclimate.json
        description: The output path. (default "coverage/codeclimate.json")
        type: string
    steps:
      - run:
          command: cc-test-reporter format-coverage "<<parameters.additional_flags>>" "<<parameters.coverage_file>>" --input-type <<parameters.input_type>> --output "<<parameters.output>>"
          name: Formatting coverage report

  install:
    description: Install the Code Climate rest reporter.
    parameters:
      version:
        default: latest
        description: The version of Code Climate test reporter to download. (default latest)
        type: string
    steps:
      - run:
          command: |
            if [[ $(command -v cc-test-reporter) == "" ]]; then
              if which sudo > /dev/null; then
                sudo curl -s -o /usr/local/bin/cc-test-reporter -L https://codeclimate.com/downloads/test-reporter/test-reporter-<<parameters.version>>-linux-amd64
                sudo chmod +x /usr/local/bin/cc-test-reporter
              else
                curl -s -o /usr/local/bin/cc-test-reporter -L https://codeclimate.com/downloads/test-reporter/test-reporter-<<parameters.version>>-linux-amd64
                chmod +x /usr/local/bin/cc-test-reporter
              fi
            else
              echo "Test reporter is already installed."
            fi
          name: Downloading Code Climate test reporter

  sum_coverage:
    description: Combine (sum) multiple pre-formatted coverage payloads into one.
    parameters:
      input:
        description: File glob of the files to combine.
        type: string
      output:
        default: coverage/codeclimate.json
        description: The output path. (default "coverage/codeclimate.json")
        type: string
      parts:
        default: 1
        description: The total number of parts to sum. (default 1)
        type: integer
    steps:
      - run:
          command: cc-test-reporter sum-coverage <<parameters.input>> --parts <<parameters.parts>> --output "<<parameters.output>>"
          name: Combining coverage reports

  upload_coverage:
    description: Upload pre-formatted coverage payloads to Code Climate servers.
    parameters:
      input:
        default: coverage/codeclimate.json
        description: The input path. (default "coverage/codeclimate.json")
        type: string
    steps:
      - run:
          command: cc-test-reporter upload-coverage --input "<<parameters.input>>"
          name: Uploading coverage report
