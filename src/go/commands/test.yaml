description: |
  A more extensive go test function that is parameterized
  There's already a pending PR here: https://github.com/CircleCI-Public/go-orb/pull/16
parameters:
  code_path:
    description: which tests to run
    type: string
    default: "./..."
  race:
    description: run tests with -race option
    type: boolean
    default: true
  count:
    description: run each test and benchmark n times
    type: string
    default: "5" # the go default is: "1"
  failfast:
    description: do not start new tests after the first test failure
    type: boolean
    default: true
  short:
    description: tell long-running tests to shorten their run time
    type: boolean
    default: true
  parallel:
    description: |
      Allow parallel execution of test functions that call t.Parallel.
      The value of this flag is the maximum number of tests to run
      simultaneously
    type: string
    default: "1"
  coverprofile:
    description: file to save coverage profile
    type: string
    default: "cover-source.out"
  covermode:
    description: flag to set the coverage mode
    type: enum
    enum: ["set", "count", "atomic"]
    default: "atomic"  # the go default is: "set", however unless -race is enabled, in which case it is "atomic"
steps:
  - run:
      command: >-
        go test
        <<# parameters.race >>-race<</ parameters.race >>
        -count=<<parameters.count>>
        -coverprofile=<<parameters.coverprofile>>
        <<# parameters.failfast >>-failfast<</ parameters.failfast >>
        <<# parameters.short >>-short<</ parameters.short >>
        -p <<parameters.parallel>>
        -covermode=<<parameters.covermode>>
        <<parameters.code_path>>
      name: '[go] Test'
