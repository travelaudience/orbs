description: Regenerate protobuf files to compare with auto-generated files pushed
parameters:
  exec:
    description: Executor to use for this job
    type: executor
    default: go_executor
  protobuf_version:
    description: The version of protobuf tool to install
    type: string
    default: "3.15.3"
  protoc_version:
    # Upgrading to v1.4.x introduces a new structure to the generated code in *.pb.go.  This new structure is
    # incompatible with our code and also with the code generated by mockery.
    description: Version of protoc-gen-go to install
    default: "v1.3.5"
    type: string
  mockery_version:
    description: Version of mockery to install
    default: "v1.1.2"
    type: string
executor: <<parameters.exec>>
steps:
  - protobuf/install:
      version: <<parameters.protobuf_version>>
    # Permissions are not as we'd like them by default.  Need to explicitly allow access to protobuf.
  - run: sudo chmod -R +rX /usr/local/include/google
  - run: sudo chmod +x /usr/local/bin/protoc
  - checkout
  - go/load-cache
  - make-gen:
      protoc_version: <<parameters.protoc_version>>
      mockery_version: <<parameters.mockery_version>>
  - compare
  - go/save-cache
