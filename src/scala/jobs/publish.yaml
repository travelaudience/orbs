description: |
  Publish snapshot/release .jar depending on the version from a git tag.

parameters:
  executor:
    description: Executor to use for this job
    type: executor
    default: scala
  cache_key:
    description: Checksum-based key used to identify cache
    type: string
    default: ''

executor: << parameters.executor >>

steps:
  - read_workspace
  - read_cache:
      cache_key: << parameters.cache_key >>
  - run:
      name: Package .jar files
      command: sbt +package
  - run:
      name: Publish .jar files
      command: |
        #!/usr/bin/env bash
        TAG_PATTERN='(?<=v).+'
        VERSION_TAG=$(set +e; echo "$CIRCLE_TAG" | grep -P -o $TAG_PATTERN || true)  # '1.0.0' without 'v' prefix

        if [[ ! -z "$VERSION_TAG" ]]; then
          SNAPSHOT_VERSION=$(echo $VERSION_TAG|sed 's/-SNAPSHOT$//')-SNAPSHOT
          VERSION_SBT_PATTERN="^ThisBuild / version := \"$SNAPSHOT_VERSION\"$"
          if egrep "$VERSION_SBT_PATTERN" version.sbt; then
            echo "Publishing $VERSION_TAG ..."
            sbt 'set ThisBuild / version := "'"$VERSION_TAG"'"' +publish
          else
            echo "CIRCLE_TAG '$CIRCLE_TAG' does not match version.sbt (pattern $VERSION_SBT_PATTERN), skipping publish!"
            exit -1
          fi
        elif [[ ! -z "$CIRCLE_TAG" ]]; then
          echo "CIRCLE_TAG '$CIRCLE_TAG' does not match '$TAG_PATTERN', skipping publish!"
          exit -2
        else
          VERSION_SBT_PATTERN="^version in ThisBuild := \".+-SNAPSHOT\"$"
          if egrep "$VERSION_SBT_PATTERN" version.sbt; then
            echo 'Publishing using version.sbt ...'
            sbt +publish
          else
            echo "version.sbt must contain a version with pattern $VERSION_SBT_PATTERN!"
            exit -3
          fi
        fi
